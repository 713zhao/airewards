rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is a parent in any family
    function isParentInFamily(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)) 
        && get(/databases/$(database)/documents/users/$(userId)).data.accountType == 'parent';
    }
    
    // Helper function to check if user belongs to the same family
    function isInSameFamily(userId1, userId2) {
      let user1 = get(/databases/$(database)/documents/users/$(userId1)).data;
      let user2 = get(/databases/$(database)/documents/users/$(userId2)).data;
      return user1.familyId != null && user1.familyId == user2.familyId;
    }
    
    // Users collection - Enhanced family access
    match /users/{userId} {
  // Users can always read/write their own document, even if familyId is null
  allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Parents can read their children's user documents
      allow read: if request.auth != null 
        && isParentInFamily(request.auth.uid)
        && isInSameFamily(request.auth.uid, userId);
      
      // Allow reading any user document for family functionality
      // (In production, you might want to restrict this more)
      allow read: if request.auth != null;
    }
    
    // Tasks collection - Enhanced family task management
    match /tasks/{taskId} {
      // Allow reading tasks assigned to the user or anyone in the same family
      allow read: if request.auth != null
        && (
          resource.data.assignedToUserId == request.auth.uid
          || isInSameFamily(request.auth.uid, resource.data.assignedToUserId)
        );

      // Allow updates/deletes when user manages their own tasks or a parent manages family tasks
      allow update, delete: if request.auth != null
        && (
          resource.data.assignedToUserId == request.auth.uid
          || (isParentInFamily(request.auth.uid)
              && isInSameFamily(request.auth.uid, resource.data.assignedToUserId))
        );

      // Allow creating new tasks
      allow create: if request.auth != null
        && (
          request.resource.data.assignedToUserId == request.auth.uid
          || (isParentInFamily(request.auth.uid)
              && isInSameFamily(request.auth.uid, request.resource.data.assignedToUserId))
        );
    }
    
    // Families collection - Enhanced family access
    match /families/{familyId} {
      allow read, write: if request.auth != null 
        && (
          // Family admin/parent
          resource.data.adminUserId == request.auth.uid
          // Or family member
          || request.auth.uid in resource.data.memberIds
          // Backward compatibility with ownerId
          || resource.data.ownerId == request.auth.uid
        );
      // Allow creating families even if user has no familyId
      allow create: if request.auth != null;
    }
    
    // Rewards collection - Family rewards management
    match /rewards/{rewardId} {
      // Anyone in the family can read rewards
      allow read: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && (
          // Reward has no family (legacy) or user is in the same family
          !('familyId' in resource.data) 
          || resource.data.familyId == null
          || resource.data.familyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId
        );
      
      // Only parents can create/update/delete rewards
      allow create: if request.auth != null 
        && isParentInFamily(request.auth.uid)
        && (
          !('familyId' in request.resource.data)
          || request.resource.data.familyId == null
          || request.resource.data.familyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId
        );
      
      allow update, delete: if request.auth != null 
        && isParentInFamily(request.auth.uid)
        && (
          !('familyId' in resource.data)
          || resource.data.familyId == null
          || resource.data.familyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId
        );
    }
    
    // Transactions collection - Enhanced family transaction access
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null 
        && (
          // User can access their own transactions
          resource.data.userId == request.auth.uid
          // Or family admin can access family transactions
          || resource.data.familyId == request.auth.uid
          // Or parent can access their children's transactions
          || (isParentInFamily(request.auth.uid) 
              && isInSameFamily(request.auth.uid, resource.data.userId))
        );
    }
    
    // Goals collection - User goals management
    match /goals/{goalId} {
      // Users can read/write their own goals
      allow read, write: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // Allow creating goals
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Parents can read their children's goals
      allow read: if request.auth != null 
        && isParentInFamily(request.auth.uid)
        && isInSameFamily(request.auth.uid, resource.data.userId);
    }
    
    // Allow test collection for debugging (remove in production)
    match /test/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // Allow broader access for development (restrict in production)
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}